CREATE OR REPLACE PROCEDURE "ENOC"."ACTUALIZA_DIFERIDA" AS 

BEGIN
  
    /* INSERTAR NOTAS DIFERIDAS VENCIDAS EN LA TABLA 'KRDX_CURSO_DIFERIDAS_VENCIDAS' */
    
    INSERT INTO KRDX_CURSO_DIFERIDAS_VENCIDAS(CODIGO_PERSONAL, CURSO_CARGA_ID, CURSO_ID, FECHA, NOTA, TIPOCAL_ID, ESTADO)
    SELECT 
      A.CODIGO_PERSONAL, 
      A.CURSO_CARGA_ID, 
      A.CURSO_ID, 
      SYSDATE, 
      B.NOTA, 
      CASE
        WHEN B.NOTA >= (SELECT NOTA_APROBATORIA FROM MAPA_CURSO WHERE CURSO_ID = A.CURSO_ID) THEN 1
        ELSE 2
      END,
      'PROCESANDO'
    FROM KRDX_CURSO_ACT A
    INNER JOIN KRDX_CURSO_CAL B
      ON A.CODIGO_PERSONAL = B.CODIGO_PERSONAL AND A.CURSO_CARGA_ID = B.CURSO_CARGA_ID AND A.CURSO_ID = B.CURSO_ID
    WHERE A.TIPOCAL_ID = '6'
    AND B.TIPO = 'D'
    AND B.FECHA_FINAL < SYSDATE
    AND (SELECT TIPOCURSO_ID FROM MAPA_CURSO WHERE CURSO_ID = A.CURSO_ID) NOT IN (10, 8) /* EXCLUIR EL TIPO CULMINANTE (10) Y EL AC/NA (8) */ 
    AND A.CODIGO_PERSONAL||A.CURSO_CARGA_ID NOT IN (SELECT CODIGO_PERSONAL||CURSO_CARGA_ID FROM KRDX_CURSO_DIFERIDAS_VENCIDAS);
    
    /* ACTUALIZAR KRDX_CURSO_CAL PARA INDICARLE QUE SE HA HECHO UNA CORRECION DE NOTA A LA DIFERIDA */    
    UPDATE KRDX_CURSO_CAL
    SET TIPO = 'C'
    WHERE CODIGO_PERSONAL||CURSO_CARGA_ID||CURSO_ID IN (
        SELECT CODIGO_PERSONAL||CURSO_CARGA_ID||CURSO_ID FROM KRDX_CURSO_DIFERIDAS_VENCIDAS
        WHERE ESTADO = 'PROCESANDO'
    );    
    
    /* ACTUALIZAR KRDX_CURSO_ACT PARA CORREGIR LA NOTA */    
    UPDATE KRDX_CURSO_ACT
    SET 
    NOTA        = (SELECT NOTA FROM KRDX_CURSO_DIFERIDAS_VENCIDAS WHERE CODIGO_PERSONAL = KRDX_CURSO_ACT.CODIGO_PERSONAL AND CURSO_CARGA_ID = KRDX_CURSO_ACT.CURSO_CARGA_ID AND CURSO_ID = KRDX_CURSO_ACT.CURSO_ID),
    F_NOTA      = (SELECT FECHA FROM KRDX_CURSO_DIFERIDAS_VENCIDAS WHERE CODIGO_PERSONAL = KRDX_CURSO_ACT.CODIGO_PERSONAL AND CURSO_CARGA_ID = KRDX_CURSO_ACT.CURSO_CARGA_ID AND CURSO_ID = KRDX_CURSO_ACT.CURSO_ID),
    TIPOCAL_ID  = (SELECT COALESCE(TIPOCAL_ID,'2') FROM KRDX_CURSO_DIFERIDAS_VENCIDAS WHERE CODIGO_PERSONAL = KRDX_CURSO_ACT.CODIGO_PERSONAL AND CURSO_CARGA_ID = KRDX_CURSO_ACT.CURSO_CARGA_ID AND CURSO_ID = KRDX_CURSO_ACT.CURSO_ID),
    CORRECCION  = 'S'
    WHERE CODIGO_PERSONAL||CURSO_CARGA_ID||CURSO_ID IN (
        SELECT CODIGO_PERSONAL||CURSO_CARGA_ID||CURSO_ID FROM KRDX_CURSO_DIFERIDAS_VENCIDAS
        WHERE ESTADO = 'PROCESANDO'
    );   
    
    /* CAMBIAR ESTADO EN KRDX_CURSO_DIFERIDAS_VENCIDAS */    
    UPDATE KRDX_CURSO_DIFERIDAS_VENCIDAS
    SET ESTADO = 'COMPLETADO'
    WHERE ESTADO = 'PROCESANDO';
    
END;
/

CREATE OR REPLACE PROCEDURE "ENOC"."CALCULA_NOTA_MAXIMA" AS   
  PAR_EXISTE NUMBER(1);
  PAR_EVALUADOS NUMBER(5,2);
  PAR_PUNTOS_PORCENTAJE NUMBER(5,2);
  PAR_PUNTOS_DIRECTOS NUMBER(5,2);
  PAR_MAXIMO NUMBER(5,2);
  
  PAR_CARRERA VARCHAR2(5);
  CURSOR C_NOTA IS SELECT CODIGO_PERSONAL,CURSO_CARGA_ID FROM ENOC.MOD_NOTA WHERE ESTADO = 'A';   
BEGIN  
  FOR REGISTRO IN C_NOTA LOOP

    SELECT COUNT(*) INTO PAR_EXISTE FROM ENOC.KRDX_MAXIMO WHERE CURSO_CARGA_ID = REGISTRO.CURSO_CARGA_ID AND CODIGO_PERSONAL = REGISTRO.CODIGO_PERSONAL;
    
    SELECT CARRERA_ID INTO PAR_CARRERA FROM ENOC.CARGA_GRUPO WHERE CURSO_CARGA_ID = REGISTRO.CURSO_CARGA_ID;
    IF (PAR_CARRERA IS NULL) THEN PAR_CARRERA := '00000'; END IF;
    
    SELECT COALESCE(SUM(EVALUADAS*VALOR/100),0) INTO PAR_EVALUADOS
    FROM ENOC.ALUMNO_EFICIENCIA
    WHERE CURSO_CARGA_ID = REGISTRO.CURSO_CARGA_ID
    AND CODIGO_PERSONAL = REGISTRO.CODIGO_PERSONAL;

    SELECT COALESCE(SUM(EVALUADAS*VALOR/100*NOTA/EVALUADAS),0) INTO PAR_PUNTOS_PORCENTAJE
    FROM ENOC.ALUMNO_EFICIENCIA
    WHERE CURSO_CARGA_ID = REGISTRO.CURSO_CARGA_ID
    AND CODIGO_PERSONAL = REGISTRO.CODIGO_PERSONAL
    AND TIPO = '%'
    AND EVALUADAS > 0;
    
    SELECT COALESCE(SUM(NOTA),0) INTO PAR_PUNTOS_DIRECTOS
    FROM ENOC.ALUMNO_EFICIENCIA
    WHERE CURSO_CARGA_ID = REGISTRO.CURSO_CARGA_ID
    AND CODIGO_PERSONAL = REGISTRO.CODIGO_PERSONAL
    AND TIPO IN ('P','E')
    AND EVALUADAS > 0;
    
    PAR_MAXIMO := 100 - PAR_EVALUADOS + PAR_PUNTOS_PORCENTAJE + PAR_PUNTOS_DIRECTOS;

    IF (PAR_EXISTE >= 1) THEN 
      UPDATE ENOC.KRDX_MAXIMO SET EVALUADAS = PAR_EVALUADOS, PUNTOS = PAR_PUNTOS_PORCENTAJE+PAR_PUNTOS_DIRECTOS, MAXIMO = PAR_MAXIMO, CARRERA_ID = PAR_CARRERA WHERE CURSO_CARGA_ID = REGISTRO.CURSO_CARGA_ID AND CODIGO_PERSONAL = REGISTRO.CODIGO_PERSONAL;
    ELSE
      INSERT INTO ENOC.KRDX_MAXIMO(CURSO_CARGA_ID, CODIGO_PERSONAL, EVALUADAS, PUNTOS, MAXIMO, CARRERA_ID) VALUES(REGISTRO.CURSO_CARGA_ID, REGISTRO.CODIGO_PERSONAL, PAR_EVALUADOS, PAR_PUNTOS_PORCENTAJE+PAR_PUNTOS_DIRECTOS, PAR_MAXIMO, PAR_CARRERA);
    END IF;

    UPDATE ENOC.MOD_NOTA SET ESTADO = 'I' WHERE CODIGO_PERSONAL = REGISTRO.CODIGO_PERSONAL AND CURSO_CARGA_ID = REGISTRO.CURSO_CARGA_ID;

  END LOOP;
  DELETE FROM ENOC.MOD_NOTA WHERE ESTADO = 'I';
END CALCULA_NOTA_MAXIMA;
/

CREATE OR REPLACE PROCEDURE "ENOC"."CALCULA_PROMEDIO" AS   
  PAR_CREDITOS NUMBER(5,2);
  CURSOR C_PROMEDIO IS SELECT CODIGO_PERSONAL,PLAN_ID,FECHA, ESTADO FROM ENOC.MOD_PROMEDIO WHERE ESTADO = 'A';   
BEGIN  
  FOR REGISTRO IN C_PROMEDIO LOOP     
    SELECT COALESCE(SUM(CREDITOS),0) INTO PAR_CREDITOS FROM ENOC.ALUMNO_CURSO 
    WHERE CODIGO_PERSONAL = REGISTRO.CODIGO_PERSONAL 
    AND PLAN_ID = REGISTRO.PLAN_ID
    AND ENOC.TIPOCURSO_ID(CURSO_ID) IN (SELECT TIPOCURSO_ID FROM ENOC.CAT_TIPOCURSO WHERE PROMEDIA = 'S');

    IF (PAR_CREDITOS > 0) THEN
      UPDATE ENOC.ALUM_PLAN 
      SET PROMEDIO = ENOC.ALUM_PROMEDIO(REGISTRO.CODIGO_PERSONAL,REGISTRO.PLAN_ID), 
      CREDITOS = ENOC.ALUM_CREDITOS(REGISTRO.CODIGO_PERSONAL, REGISTRO.PLAN_ID),
      CICLO = ENOC.ALUM_PLAN_CICLO(REGISTRO.CODIGO_PERSONAL, REGISTRO.PLAN_ID)
      WHERE CODIGO_PERSONAL = REGISTRO.CODIGO_PERSONAL AND PLAN_ID = REGISTRO.PLAN_ID;
      UPDATE ENOC.MOD_PROMEDIO SET ESTADO = 'I' WHERE CODIGO_PERSONAL = REGISTRO.CODIGO_PERSONAL AND PLAN_ID = REGISTRO.PLAN_ID;
    END IF;
  END LOOP;
  DELETE FROM ENOC.MOD_PROMEDIO WHERE ESTADO = 'I';
END CALCULA_PROMEDIO;
/

CREATE OR REPLACE PROCEDURE "ENOC"."CICLO_UPDATE" AS
  PAR_CICLO NUMBER(2);
  CURSOR C_CICLO IS SELECT CODIGO_PERSONAL,CARGA_ID,BLOQUE_ID,PLAN_ID,ESTADO FROM ENOC.MOD_CICLO WHERE ESTADO = 'A';
BEGIN  
  FOR REGISTRO IN C_CICLO LOOP     
    UPDATE ENOC.ALUM_ESTADO SET CICLO = ENOC.ALUM_CARGA_CICLO(REGISTRO.CODIGO_PERSONAL, REGISTRO.PLAN_ID, REGISTRO.CARGA_ID) 
    WHERE CODIGO_PERSONAL = REGISTRO.CODIGO_PERSONAL AND CARGA_ID = REGISTRO.CARGA_ID 
    AND BLOQUE_ID = REGISTRO.BLOQUE_ID AND PLAN_ID = REGISTRO.PLAN_ID;
    UPDATE ENOC.MOD_CICLO SET ESTADO = 'I' WHERE CODIGO_PERSONAL = REGISTRO.CODIGO_PERSONAL AND CARGA_ID = REGISTRO.CARGA_ID 
    AND BLOQUE_ID = REGISTRO.BLOQUE_ID AND PLAN_ID = REGISTRO.PLAN_ID;
  END LOOP;
  DELETE FROM ENOC.MOD_CICLO WHERE ESTADO = 'I';
END CICLO_UPDATE;
/